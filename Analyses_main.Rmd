---
title: "Main analyses"
author: "Ana Macanovic"
date: "2025-05-10"
---

# Main Analyses

Analyses presented in the main text of the manuscript. 

Load the packages:
```{r message=  F, warning = F, eval = T}
source("helper_functions.R")
packages_to_load <- c("readr", "dplyr", "tidyr", 
                      "ggplot2", "cowplot",
                      "tidyverse", "RPostgres", 
                      "lubridate", "lmtest", 
                      "sandwich", "ggpubr", 
                      "knitr", "scales", 
                      "ggeffects", "flextable", 
                      "officer", "MASS",
                      "DescTools", "stevemisc")

fpackage_check(packages_to_load)


# For full reproducibility, load the packages with groundhog using the code below instead
# of the fpackage_check function

# library(groundhog)
# groundhog.library(packages_to_load, date = "2024-4-23")
```


```{r}
opts_chunk$set(echo = TRUE)
opts_chunk$set(eval = TRUE)
opts_chunk$set(warning = FALSE)
opts_chunk$set(message = FALSE)
```


Load the panel:
```{r warning = F, message = F}
prof_panel_filter <- read_csv("panel_datasets/prof_panel_anonymised.csv")
```

# Figure 1: Examples

There examples are manually selected from our panel dataset and our database.

# Figure 2: Descriptive results


## Figure 2A: Mention averages

Average numbers of mentions and comparison per gender.

First, get the totals for the last observation for each professor:
```{r}
prof_totals <- prof_panel_filter %>%
  group_by(profile_id)%>%
  filter(year == max(year) & !is.na(overall_adj_domain))
```

Within-field comparison:
```{r}
fields <- unique(prof_panel_filter$overall_adj_domain)
fields <- fields[!is.na(fields)]
field_comparisons <- data.frame(matrix(NA, ncol = 5, nrow = length(fields)))

for (i in 1:length(fields)){
  field <- fields[i]
  data <- filter(prof_totals, 
                 overall_adj_domain == field)
  field_comparisons[i, 1] <- field
  field_comparisons[i, 2] <- nrow(data)
  field_comparisons[i, 3] <- round(t.test(news_all_total ~ inferred_gender, data=data, paired=FALSE)$p.value, 5)
  field_comparisons[i, 4] <- round(t.test(alt_online_all_total ~ inferred_gender, data=data, paired=FALSE)$p.value, 5)
  field_comparisons[i, 5] <- round(t.test(alt_twitter_total ~ inferred_gender, data=data, paired=FALSE)$p.value, 5)
}

colnames(field_comparisons) <- c("field", "profs",
                                 "total", "online_total", "twitter_total")
field_comparisons$comparison <-  "ttest"


mean_values_field <- prof_totals %>%
  filter(!is.na(overall_adj_domain))%>%
  group_by(inferred_gender, overall_adj_domain)%>%
  summarise(total = mean(news_all_total, na.rm = TRUE),
            online_total = mean(alt_online_all_total, na.rm = TRUE),
            twitter_total =  mean(alt_twitter_total, na.rm = TRUE),
            total_sd = sd(news_all_total, na.rm = TRUE),
            online_total_sd = sd(alt_online_all_total, na.rm = TRUE),
            twitter_total_sd =  sd(alt_twitter_total, na.rm = TRUE),
            all_n = n())%>%
  mutate(
    
    total_se = total_sd / sqrt(all_n),
    online_total_se = online_total_sd / sqrt(all_n),
    twitter_total_se =  twitter_total_sd / sqrt(all_n),
    
    total_lci = total - qt(1 - (0.05 / 2), all_n - 1) * total_se,
    online_total_lci = online_total - qt(1 - (0.05 / 2), all_n - 1) * online_total_se,
    twitter_total_lci =  twitter_total - qt(1 - (0.05 / 2), all_n - 1) * twitter_total_se,
    
    total_uci = total + qt(1 - (0.05 / 2), all_n - 1) * total_se,
    online_total_uci = online_total + qt(1 - (0.05 / 2), all_n - 1) * online_total_se,
    twitter_total_uci =  twitter_total + qt(1 - (0.05 / 2), all_n - 1) * twitter_total_se)%>%
  mutate(across(2:17, \(x) round(x, 3)))

colnames(mean_values_field)[1] <- "comparison"
colnames(mean_values_field)[2] <- "field"
```

Plot the means comparison:
```{r}
mean_values_field$field <- factor(mean_values_field$field,
                                  levels = c("Physical Sciences",
                                             "Life Sciences",
                                             "Health Sciences",
                                             "Social Sciences",
                                             "Arts and Humanities"))
mean_values_field$comparison <- ordered(mean_values_field$comparison,
                                        levels = c("m", "w"))

significance_testing <-  field_comparisons

significance_testing <-  significance_testing %>%
  filter(comparison == "ttest")%>%
  mutate_at(vars(`online_total`, `total`, `twitter_total`), .funs = list(
    ~case_when(
      . <= 0.001 ~ '***',
      . <= 0.01 ~ '**',
      . <= 0.05 ~ '*',
      . <= 0.1 ~ '',
      . > 0.1 ~ ''
    )))

significance_testing$field <- factor(significance_testing$field,
                                     levels = c("Arts and Humanities",
                                                "Social Sciences",
                                                "Health Sciences",
                                                "Life Sciences",
                                                "Physical Sciences"))
significance_testing <- significance_testing %>%
  arrange(field)

significance_testing$group1 <- "m"
significance_testing$group2 <- "w"
significance_testing$x <- c(1,2,3,4, 5)
significance_testing$xmin <- c(0.75,1.75,2.75,3.75, 4.75)
significance_testing$xmax <- c(1.25,2.25, 3.25,4.25, 5.25)
significance_testing$comparison <- "m"


average_news <- mean_values_field %>%
  ggplot(aes(x=fct_rev(field), y=total, fill = fct_rev(comparison), color = fct_rev(comparison))) + 
  geom_bar(position=position_dodge(.5),stat="identity", alpha=1, width = 0.5)+
  geom_errorbar(
    aes(y=total, 
        x = fct_rev(field),
        group = fct_rev(comparison),
        ymin = total_lci, 
        ymax = total_uci
    ),
    width = 0.2,
    stat="identity",
    position=position_dodge(.5),)+
  guides(fill = guide_legend(reverse = TRUE, title = "Inferred gender"),
         color = guide_legend(reverse = TRUE, title = "Inferred gender"))+
  scale_fill_manual(values =  c("#F5C710", "#61D04F")  , labels = c("Women", "Men"))+
  scale_color_manual(values =  c("#997b06", "#338a25")  , labels = c("Women", "Men"), guide="none")+
  ggtitle("Printed news attention")+
  stat_pvalue_manual(
    significance_testing,
    y.position = c(190, 190, 190, 190, 190),
    label.size = 3,
    coord.flip = TRUE,
    tip.length = 0.005,
    label = "{total}",
    remove.bracket = FALSE,
    hide.ns = TRUE
  )+
  scale_y_continuous(limits = c(0, 200), breaks = seq(0, 200, by = 40))+
  ylab("Average mentions over lifetime")+
  xlab("Field")+
  labs(color = "Inferred gender",
       fill = "Inferred gender")+
  theme_minimal_vgrid()+
  theme(plot.title = element_text(size = 8),
        axis.text.y = element_text(size = 6),
        axis.title.y = element_text(size = 7),
        axis.text.x = element_text(size = 6) ,
        axis.title.x = element_text(size = 7),
        legend.title=element_text(size=7), 
        legend.text=element_text(size=6),
        legend.key.size = unit(0.1, "in"))+
  coord_flip()

average_online <- mean_values_field %>%
  ggplot(aes(x=fct_rev(field), y=online_total, fill = fct_rev(comparison), color = fct_rev(comparison))) + 
  geom_bar(position=position_dodge(.5),stat="identity", alpha=1, width = 0.5)+
  geom_errorbar(
    aes(y=total, 
        x = fct_rev(field),
        group = fct_rev(comparison),
        ymin = online_total_lci, 
        ymax = online_total_uci
    ),
    width = 0.2,
    stat="identity",
    position=position_dodge(.5),)+
  guides(fill = guide_legend(reverse = TRUE, title = "Inferred gender"),
         color = guide_legend(reverse = TRUE, title = "Inferred gender"))+
  scale_fill_manual(values =  c("#F5C710", "#61D04F")  , labels = c("Women", "Men"))+
  scale_color_manual(values =  c("#997b06", "#338a25")  , labels = c("Women", "Men"), guide="none")+
  ggtitle("Online news attention")+
  scale_y_continuous(limits = c(0, 240), breaks = seq(0, 240, by = 60))+
  stat_pvalue_manual(
    significance_testing,
    y.position = c(230, 230, 230, 230, 230),
    label.size = 3,
    coord.flip = TRUE,
    tip.length = 0.005,
    label = "{online_total}",
  )+
  ylab("Average mentions over lifetime")+
  labs(color = "Inferred gender",
       fill = "Inferred gender")+
  theme_minimal_vgrid()+
  theme(plot.title = element_text(size = 8),
        axis.text.y = element_text(size = 6),
        axis.title.y = element_text(size = 7),
        axis.text.x = element_text(size = 6) ,
        axis.title.x = element_text(size = 7),
        legend.title=element_text(size=7), 
        legend.text=element_text(size=6),
        legend.key.size = unit(0.1, "in"))+
  coord_flip()+
  xlab("Field")


average_twitter <- mean_values_field %>%
  ggplot(aes(x=fct_rev(field), y=twitter_total, fill = fct_rev(comparison), color = fct_rev(comparison))) + 
  geom_bar(position=position_dodge(.5),stat="identity", alpha=1, width = 0.5)+
  geom_errorbar(
    aes(y=total, 
        x = fct_rev(field),
        group = fct_rev(comparison),
        ymin = twitter_total_lci, 
        ymax = twitter_total_uci
    ),
    width = 0.2,
    stat="identity",
    position=position_dodge(.5),)+
  guides(fill = guide_legend(reverse = TRUE, title = "Inferred gender"),
         color = guide_legend(reverse = TRUE, title = "Inferred gender"))+
  scale_fill_manual(values =  c("#F5C710", "#61D04F")  , labels = c("Women", "Men"))+
  scale_color_manual(values =  c("#997b06", "#338a25")  , labels = c("Women", "Men"), guide="none")+
  ggtitle("Twitter/X attention")+
  stat_pvalue_manual(
    significance_testing,
    y.position = c(1480, 1480, 1480, 1480, 1480),
    label.size = 3,
    coord.flip = TRUE,
    tip.length = 0.005,
    label = "{twitter_total}",
    remove.bracket = FALSE,
  )+
  scale_y_continuous(limits = c(0, 1500), breaks = seq(0, 1500, by = 375))+
  ylab("Average mentions over lifetime")+
  labs(color = "Inferred gender",
       fill = "Inferred gender")+
  theme_minimal_vgrid()+
  theme(plot.title = element_text(size = 8),
        axis.text.y = element_text(size = 6),
        axis.title.y = element_text(size = 7),
        axis.text.x = element_text(size = 6) ,
        axis.title.x = element_text(size = 7),
        legend.title=element_text(size=7), 
        legend.text=element_text(size=6),
        legend.key.size = unit(0.1, "in"))+
  coord_flip()+
  xlab("Field")
```

Combine these plots into one (Figure 2, panel A):
```{r fig.width=10, fig.height=3}
legend_average <- get_legend(
  # create some space to the left of the legend
  average_news
)

combi_plot_averages <- plot_grid(average_news + 
                                   theme(legend.position="none", 
                                         axis.title.x = element_blank(),
                                         axis.title.y=element_blank())
                                 + panel_border(), 
                                 average_online + theme(legend.position="none",
                                                        axis.title.x = element_blank(),
                                                        axis.title.y=element_blank(),
                                                        axis.text.y = element_blank())
                                 + panel_border(), 
                                 average_twitter + theme(legend.position="none",
                                                         axis.title.y=element_blank(),
                                                         axis.title.x = element_blank(),
                                                         axis.text.y = element_blank())
                                 + panel_border(), 
                                 legend_average,
                                 ncol = 4,
                                 rel_widths = c(1.3, 0.9, 0.9, 0.4))

combi_plot_averages
```


## Figure 2B: Women's representation

First, get representation per field in our dataset:
(6,791 professors)
```{r}
repr_field_2023 <- prof_panel_filter %>%
  group_by(profile_id)%>%
  filter(year == max(year))%>%
  filter(!is.na(overall_adj_domain))%>%
  group_by(overall_adj_domain, inferred_gender)%>%
  summarise(n = n())%>%
  pivot_wider(values_from = n, names_from = inferred_gender)

repr_field_2023$share_women_field <- repr_field_2023$w/(repr_field_2023$m+repr_field_2023$w)

```

### Among top N researchers 
Now get the representation of women among the top 10% and 20% of researchers in terms
of total fame in their field in 2023 (based on their entry batch):
```{r}
# first, get the latest year in the panel for each prof
women_field_2023 <- prof_panel_filter %>%
  group_by(profile_id)%>%
  filter(year == max(year))

# and now set the final year as 2023, assuming there was no attention after
# whatever the last year is in the dataset (quite some professors with
# 0 mentions even in this last year, so we want to keep them for correct
# shares)
women_field_2023$year <- 2023

# get their decile based on their total performance within their general field
women_field_2023 <- women_field_2023 %>%
  filter(!is.na(overall_adj_domain))%>%
  dplyr::select(profile_id, year, inferred_gender, overall_adj_domain, count_pubs_total,
                cited_by_total_all, alt_online_all_total, news_all_total, alt_twitter_total)%>%
  mutate(across(count_pubs_total:alt_twitter_total, ~replace(., is.na(.), 0)))%>%
  group_by(overall_adj_domain)%>%
  mutate(`News` = ntile(-news_all_total, 20),
         `Online news` = ntile(-alt_online_all_total, 20),
         `Twitter` = ntile(-alt_twitter_total, 20))
```

Get shares of women among top n% scientists per attention domain:
```{r}
# rearrange the dataset to get counts of women and men in each decile
# then leave only top 10 and 20
share_women_field_2023 <- women_field_2023 %>%
  ungroup()%>%
  dplyr::select(profile_id, year, inferred_gender, overall_adj_domain, `News`:`Twitter`)%>%
  pivot_longer(`News`:`Twitter`)%>%
  group_by(overall_adj_domain, inferred_gender, name, value)%>%
  summarise(n = n())%>%
  pivot_wider(values_from = n, names_from = inferred_gender)%>%
  replace(is.na(.), 0)%>%
  group_by(overall_adj_domain, name)%>%
  mutate(m = cumsum(m),
         w = cumsum(w))%>%
  filter(value %in% c(1, 2))

share_women_field_2023$share_women <- share_women_field_2023$w/(share_women_field_2023$m+share_women_field_2023$w) 
```
Combine the field representation with the attention representation:
```{r}
repr_field_2023$name <- "overall"
repr_field_2023$value <- 0

repr_field_2023 <- repr_field_2023[c(colnames(share_women_field_2023)[1:5],"share_women_field")]

share_women_field_2023 <- merge(share_women_field_2023,
                                repr_field_2023[c("overall_adj_domain", "share_women_field")],
                                by = "overall_adj_domain")

share_women_field_2023$share_diff <- (share_women_field_2023$share_women - share_women_field_2023$share_women_field)*100

```

Plot this out:

Top 5% and top 10%:
```{r warning = F}

share_women_field_2023$overall_adj_domain <- factor(share_women_field_2023$overall_adj_domain,
                                                    levels = c("Physical Sciences",
                                                               "Life Sciences",
                                                               "Health Sciences",
                                                               "Social Sciences",
                                                               "Arts and Humanities"))

repr_attn_5 <- share_women_field_2023 %>%
  filter(value == 1 & name %in% c("News", "Online news", "Twitter"))%>%
  ggplot(aes(y=share_diff, x=fct_rev(overall_adj_domain), fill=name, color=name)) + 
  geom_bar(position = position_dodge2(reverse = TRUE, width = 1.4), stat="identity", width = 1.4)+
  guides(fill = guide_legend(reverse=FALSE, title = "Measure"),
         color = guide_legend(reverse=FALSE, title = "Measure"))+
  scale_color_manual(labels = c("Printed news", "Online news", "Twitter/X"), values = c("#8f4765", "#da1f17", "#3f5f84"))+
  scale_fill_manual(labels = c("Printed news", "Online news", "Twitter/X"), values = c("#bb7693", "#ef6f6a", "#6388b4"))+
  scale_y_continuous(limits = c(-20, 15), breaks = seq(-20, 15, by = 5))+
  scale_x_discrete(limits = c(levels(share_women_field_2023$overall_adj_domain)[5],
                              "A",
                              levels(share_women_field_2023$overall_adj_domain)[4],
                              "B",
                              levels(share_women_field_2023$overall_adj_domain)[3],
                              "C",
                              levels(share_women_field_2023$overall_adj_domain)[2],
                              "D",
                              levels(share_women_field_2023$overall_adj_domain)[1]),
                   labels = c("A" = "",
                              "B" = "",
                              "C" = "",
                              "D" = ""))+
  geom_hline(yintercept=0, 
             color = "black", size=0.7)+
  coord_flip()+
  xlab("")+
  ylab("Under-/overrepresentation of women (in %)")+
  labs(color = "Attention type",
       fill = "Attention type")+
  ggtitle("Top 5% of attention type")+
  theme_minimal_vgrid()+
  theme(plot.title = element_text(size = 8),
        axis.text.y = element_text(size = 6),
        axis.title.y = element_text(size = 7),
        axis.text.x = element_text(size = 6) ,
        axis.title.x = element_text(size = 7),
        legend.title=element_text(size=7), 
        legend.text=element_text(size=6),
        legend.key.size = unit(0.1, "in"))+
  panel_border()

repr_attn_10 <- share_women_field_2023 %>%
  filter(value == 2 & name %in% c("News", "Online news", "Twitter"))%>%
  ggplot(aes(y=share_diff, x=fct_rev(overall_adj_domain), fill=name, color=name)) + 
  geom_bar(position = position_dodge2(reverse = TRUE, width = 1.4), stat="identity", width = 1.4)+
  guides(fill = guide_legend(reverse=FALSE, title = "Measure"),
         color = guide_legend(reverse=FALSE, title = "Measure"))+
  scale_color_manual(labels = c("Printed news", "Online news", "Twitter/X"), values = c("#8f4765", "#da1f17", "#3f5f84"))+
  scale_fill_manual(labels = c("Printed news", "Online news", "Twitter/X"), values = c("#bb7693", "#ef6f6a", "#6388b4"))+
  scale_y_continuous(limits = c(-20, 15), breaks = seq(-20, 15, by = 5))+
  scale_x_discrete(limits = c(levels(share_women_field_2023$overall_adj_domain)[5],
                              "A",
                              levels(share_women_field_2023$overall_adj_domain)[4],
                              "B",
                              levels(share_women_field_2023$overall_adj_domain)[3],
                              "C",
                              levels(share_women_field_2023$overall_adj_domain)[2],
                              "D",
                              levels(share_women_field_2023$overall_adj_domain)[1]),
                   labels = c("A" = "",
                              "B" = "",
                              "C" = "",
                              "D" = ""))+
  geom_hline(yintercept=0, 
             color = "black", size=0.7)+
  coord_flip()+
  xlab("")+
  ylab("Under-/overrepresentation of women (in %)")+
  labs(color = "Attention type",
       fill = "Attention type")+
  ggtitle("Top 10% of attention type")+
  theme_minimal_vgrid()+
  theme(plot.title = element_text(size = 8),
        axis.text.y = element_text(size = 6),
        axis.title.y = element_text(size = 7),
        axis.text.x = element_text(size = 6) ,
        axis.title.x = element_text(size = 7),
        legend.title=element_text(size=7), 
        legend.text=element_text(size=6),
        legend.key.size = unit(0.1, "in"))+
  panel_border()
```

### Within total attention

Now get the shares of attention given to women compared to their share in the
field:
```{r}
# first, get the latest year in the panel for each prof
women_field_2023 <- prof_panel_filter %>%
  group_by(profile_id)%>%
  filter(year == max(year))

# and now set the final year as 2023, assuming there was no attention after
# whatever the last year is in the dataset (quite some professors with
# 0 mentions even in this last year, so we want to keep them for correct
# shares)
women_field_2023$year <- 2023

# get their decile based on their total performance within their entry batch
women_field_2023_attn_share <- women_field_2023 %>%
  filter(!is.na(overall_adj_domain))%>%
  dplyr::select(profile_id, year, inferred_gender, overall_adj_domain, count_pubs_total,
                cited_by_total_all, alt_online_all_total, news_all_total, alt_twitter_total)%>%
  mutate(across(count_pubs_total:alt_twitter_total, ~replace(., is.na(.), 0)))%>%
  group_by(overall_adj_domain)%>%
  summarise(
    pub_w = sum(count_pubs_total[inferred_gender == "w"]),
    cit_w = sum(cited_by_total_all[inferred_gender == "w"]), 
    online_w = sum(alt_online_all_total[inferred_gender == "w"]),
    news_w = sum(news_all_total[inferred_gender == "w"]),
    twitter_w = sum(alt_twitter_total[inferred_gender == "w"]),
    pub = sum(count_pubs_total),
    cit = sum(cited_by_total_all), 
    online = sum(alt_online_all_total),
    news = sum(news_all_total),
    twitter = sum(alt_twitter_total)
  )%>%
  mutate(
    `Publications` = pub_w/pub,
    `Citations` = cit_w/cit,    
    `Online news` = online_w/online,
    `News` = news_w/news,
    `Twitter` = twitter_w/twitter)%>%
  dplyr::select(overall_adj_domain, `Publications`:`Twitter`)%>%
  pivot_longer(!overall_adj_domain, names_to = "name", values_to = "share_women")
```
Combine the field representation with the attention representation:
```{r}
share_women_field_2023_attn_share <- merge(women_field_2023_attn_share,
                                           repr_field_2023[c("overall_adj_domain", "share_women_field")],
                                           by = "overall_adj_domain")

share_women_field_2023_attn_share$share_diff <- (share_women_field_2023_attn_share$share_women - share_women_field_2023_attn_share$share_women_field)*100
```

Plot this out:
```{r warning = F}
share_women_field_2023_attn_share$overall_adj_domain <- factor(share_women_field_2023_attn_share$overall_adj_domain,
                                                               levels = c("Physical Sciences",
                                                                          "Life Sciences",
                                                                          "Health Sciences",
                                                                          "Social Sciences",
                                                                          "Arts and Humanities"))

repr_attn_share <- share_women_field_2023_attn_share %>%
  filter(name %in% c("News", "Online news", "Twitter"))%>%
  ggplot(aes(y=share_diff, x=fct_rev(overall_adj_domain), fill=name, color=name)) + 
  geom_bar(position = position_dodge2(reverse = TRUE, width = 1.4), stat="identity", width = 1.4)+
  guides(fill = guide_legend(reverse=FALSE, title = "Attention type"),
         color = guide_legend(reverse=FALSE, title = "Attention type"))+
  scale_color_manual(labels = c("Printed news", "Online news", "Twitter/X"), values = c("#8f4765", "#da1f17", "#3f5f84"))+
  scale_fill_manual(labels = c("Printed news", "Online news", "Twitter/X"), values = c("#bb7693", "#ef6f6a", "#6388b4"))+
  scale_y_continuous(limits = c(-20, 15), breaks = seq(-20, 15, by = 5))+
  scale_x_discrete(limits = c(levels(share_women_field_2023$overall_adj_domain)[5],
                              "A",
                              levels(share_women_field_2023$overall_adj_domain)[4],
                              "B",
                              levels(share_women_field_2023$overall_adj_domain)[3],
                              "C",
                              levels(share_women_field_2023$overall_adj_domain)[2],
                              "D",
                              levels(share_women_field_2023$overall_adj_domain)[1]),
                   labels = c("A" = "",
                              "B" = "",
                              "C" = "",
                              "D" = ""))+
  geom_hline(yintercept=0, 
             color = "black", size=0.7)+
  coord_flip()+
  xlab("")+
  ylab("Under-/overrepresentation of women (in %)")+
  labs(color = "Attention type",
       fill = "Attention type")+
  ggtitle("Total attention")+
  theme_minimal_vgrid()+
  theme(plot.title = element_text(size = 8),
        axis.text.y = element_text(size = 6),
        axis.title.y = element_text(size = 7),
        axis.text.x = element_text(size = 6) ,
        axis.title.x = element_text(size = 7),
        legend.title=element_text(size=7), 
        legend.text=element_text(size=6),
        legend.key.size = unit(0.1, "in"))+
  panel_border()
```

Combine the plots for Figure 1, panel B:
```{r fig.width=10, fig.height=4}
legend_share <- get_legend(
  repr_attn_share
)


combi_plot <- plot_grid(repr_attn_share + theme(legend.position="none", 
                                                axis.title.x = element_blank(),
                                                axis.title.y=element_blank()), 
                        repr_attn_5 + theme(legend.position="none",
                                            axis.title.x = element_blank(),
                                            axis.title.y=element_blank(),
                                            axis.text.y = element_blank()),
                        repr_attn_10 + theme(legend.position="none",
                                             axis.title.y=element_blank(),
                                             axis.title.x = element_blank(),
                                             axis.text.y = element_blank()),
                        legend_share,
                        
                        
                        ncol = 4,
                        rel_widths = c(1.3, 0.9, 0.9, 0.4))

combi_plot

```

Print out Figure 1 in the main text.
```{r fig.width= 11, fig.height = 8, warning = F, message = F}

combi_plot_2 <- plot_grid(
  combi_plot_averages,
  combi_plot,
  labels = c("A","B"),
  label_size = 10,
  ncol = 1,
  nrow = 2,
  rel.heights = c(1, 1),
  align = 'v',
  axis = 'l')

combi_plot_2

ggsave2(
  filename = "results/main/Figure_2.png",
  plot = combi_plot_2,
  width = 7,
  height = 4.5,
  units = c("in"),
  dpi = 900,
  bg = "white"
)

# save a high-res publication figure
ggsave2(
  filename = "results/high_res_figures/Figure_2.tiff",
  plot = combi_plot_2,
  width = 7,
  height = 4.5,
  units = c("in"),
  dpi = 900,
  bg = "white"
)

```


# Figure 2: Regression models

Set the gender indicator to a factor, as well as some other variables of interest:
```{r}
prof_panel_filter$inferred_gender <- as.factor(prof_panel_filter$inferred_gender)
prof_panel_filter$institution_dutch_total_narcis <- as.factor(prof_panel_filter$institution_dutch_total_narcis)
```

See "helper_functions.R" for details on the function we use to fit the models.

All of our models control for:
- total publications published up to the last period
- average SJR impact factor of publications published up to the last period
- share of publications on which the professor is first/single author
- total citations received up to the last period
- total online attention received up to  the last period
- total twitter attention received up to the last period
- total citations received by all coauthors up to the last period
- printed news/online news/ Twitter/X attention received by all coauthors up to the last period (depending on the dep. var.)
- institution controls
- year controls

Individual clustered SE. Models ran per each field separately. 
We log-transform relevant count variables.

This function returns a list containing the model coefficients.

We then use this output to plot our results and output the final model
tables.

News attention models:
```{r}
news_formula_main_model <- "log(news_all+1) ~ inferred_gender + years_since_first_pub + as.factor(year) + log(count_pubs_total_l+1) + log(cited_by_total_all_l+1) + log(coa_tot_cited_by_total_l+1) + log(coa_online_combi_total_l+1) + log(alt_online_all_total_l+1) + log(alt_twitter_total_l+1) + avg_sjr_total_l + share_first_au_total_l + institution_dutch_total_narcis"


news_model_ols_log <- lm_fitter_cl_robust_scopus(panel_dataset = prof_panel_filter,
                                                 lm_formula = news_formula_main_model,
                                                 year_cutoff_upper = 2023,
                                                 year_cutoff_lower = 2012)

```

Online news attention models:
```{r}
online_news_formula_main_model <- "log(alt_online_all+1) ~ inferred_gender + years_since_first_pub + as.factor(year) + log(count_pubs_total_l+1) + log(cited_by_total_all_l+1) + log(coa_tot_cited_by_total_l+1) + log(coa_online_combi_total_l+1) + log(news_all_total_l+1) + log(alt_twitter_total_l+1) + avg_sjr_total_l + share_first_au_total_l + institution_dutch_total_narcis"


online_news_model_ols_log <- lm_fitter_cl_robust_scopus(panel_dataset = prof_panel_filter,
                                                        lm_formula = online_news_formula_main_model,
                                                        year_cutoff_upper = 2023,
                                                        year_cutoff_lower = 2012)
```
Twitter/X attention models:
```{r}
twitter_formula_main_model <- "log(alt_twitter+1) ~ inferred_gender + years_since_first_pub + as.factor(year) + log(count_pubs_total_l+1) + log(cited_by_total_all_l+1) + log(coa_tot_cited_by_total_l+1) + log(coa_online_combi_total_l+1) + log(news_all_total_l+1) + log(alt_online_all_total_l+1) + avg_sjr_total_l + share_first_au_total_l + institution_dutch_total_narcis"

twitter_model_ols_log  <- lm_fitter_cl_robust_scopus(panel_dataset = prof_panel_filter,
                                                     lm_formula = twitter_formula_main_model,
                                                     year_cutoff_upper = 2023,
                                                     year_cutoff_lower = 2012)
```
## Figure 2A: gender differences

Plot all the gender differences:
```{r}
# get the exponentiated model estimates for gender
gender_estimates1 <- news_model_ols_log[[1]]%>%
  filter(term == "inferred_genderw")
gender_estimates1$model <- "Printed news"
gender_estimates2 <- online_news_model_ols_log[[1]]%>%
  filter(term == "inferred_genderw")
gender_estimates2$model <- "Online news"
gender_estimates3 <- twitter_model_ols_log[[1]]%>%
  filter(term == "inferred_genderw")
gender_estimates3$model <- "Twitter/X"

gender_estimates <- rbind(gender_estimates1,
                          gender_estimates2,
                          gender_estimates3)

gender_estimates$model <- factor(gender_estimates$model,
                                 levels = c("Printed news",
                                            "Online news",
                                            "Twitter/X"))

gender_estimates$stars <- ifelse(gender_estimates$stars == ".",
                                 "",
                                 gender_estimates$stars)

# exponentiate the coefficiens
gender_estimates$Estimate_exp <- exp(gender_estimates$Estimate)
gender_estimates$upper_ci_exp <- exp(gender_estimates$upper_ci)
gender_estimates$lower_ci_exp <- exp(gender_estimates$lower_ci)

(all_gender_plot <- gender_estimates %>%
    ggplot(aes(x = fct_rev(field),
               y = Estimate_exp,
               ymin = upper_ci_exp,
               ymax = lower_ci_exp,
               color = field)) +
    geom_pointrange(position = position_dodge(width = 0.5),
                    size = 0.5, fatten = 2.5) +
    geom_text(data = gender_estimates, aes(x = fct_rev(field), y = Estimate_exp, label = stars), hjust = -0.8, vjust = 0.3)+
    scale_y_continuous(limits = c(0.5, 1.5), breaks = seq(0.5, 1.5, by = 0.25))+
    geom_hline(yintercept = 1, linetype="dashed")+
    scale_x_discrete(labels=c("arts" = "Arts and Humanities",
                              "health" = "Health sciences",
                              "soc_sci" = "Social sciences",
                              "life" = "Life sciences",
                              "phys" = "Physical sciences"))+
    ylab("Ratio of mean mentions for women compared to men")+
    scale_color_manual(values =  c("#1F78B4", "#33A02C", "#FF7F00", "#6A3D9A", "#B15928"))+
    theme_minimal_hgrid()+
    coord_flip()+
    facet_wrap( ~ model, ncol = 3)+
    theme(plot.title = element_text(size = 8),
          axis.text.y = element_text(size = 6),
          axis.title.y = element_blank(),
          axis.text.x = element_text(size = 6, angle = 30, hjust = 0.9) ,
          axis.title.x = element_text(size = 7),
          strip.text.x=element_text(face="bold", size = 8),
          legend.position="none")+
    panel_border())
```


## Figure 2B: Other coefficients

Combine this all to plot the coefficients in one plot.

First, prepare the dataframe:
```{r}
model_news <- news_model_ols_log[[1]]
model_online_news <- online_news_model_ols_log[[1]]
model_twitter <- twitter_model_ols_log[[1]]

model_news$model <- "News attention"
model_online_news$model <- "Online news attention"
model_twitter$model <- "Twitter attention"

all_models_plot <- rbind(model_news,
                         model_online_news,
                         model_twitter)


all_models_plot$term <- ordered(all_models_plot$term,
                                levels = c("(Intercept)",
                                           "inferred_genderw",
                                           "log(cited_by_total_all_l + 1)",
                                           "log(count_pubs_total_l + 1)",
                                           "log(news_all_total_l + 1)",
                                           "log(alt_online_all_total_l + 1)", 
                                           "log(alt_twitter_total_l + 1)",
                                           "log(coa_tot_cited_by_total_l + 1)",
                                           "log(coa_online_combi_total_l + 1)",
                                           "avg_sjr_total_l",
                                           "share_first_au_total_l",
                                           "years_since_first_pub",
                                           "as.factor(year)2014",
                                           "as.factor(year)2015",
                                           "as.factor(year)2016",
                                           "as.factor(year)2017",
                                           "as.factor(year)2018",
                                           "as.factor(year)2019",
                                           "as.factor(year)2020",
                                           "as.factor(year)2021",
                                           "as.factor(year)2022",
                                           "as.factor(year)2023",
                                           "institution_dutch_total_narcisuni_1",
                                           "institution_dutch_total_narcisuni_2",
                                           "institution_dutch_total_narcisuni_3",
                                           "institution_dutch_total_narcisuni_4",
                                           "institution_dutch_total_narcisuni_5",
                                           "institution_dutch_total_narcisuni_6",
                                           "institution_dutch_total_narcisuni_7",
                                           "institution_dutch_total_narcisuni_8",
                                           "institution_dutch_total_narcisuni_9",
                                           "institution_dutch_total_narcisuni_10",
                                           "institution_dutch_total_narcisuni_11",
                                           "institution_dutch_total_narcisuni_12",
                                           "institution_dutch_total_narcisuni_13",
                                           "institution_dutch_total_narcisuni_14",
                                           "institution_dutch_total_narcisuni_15",
                                           "R^2"))

all_models_plot$model <- ordered(all_models_plot$model,
                                 levels = c("News attention",
                                            "Online news attention",
                                            "Twitter attention" ))


all_models_plot$field <- ordered(all_models_plot$field,
                                 levels = c("phys",
                                            "life",
                                            "health",
                                            "soc_sci",
                                            "arts"))

covariate_names <- c(
  'log(cited_by_total_all_l + 1)'="Total citations\n(log-transformed)",
  'log(count_pubs_total_l + 1)'="Total publications\n(log-transformed)",
  'log(news_all_total_l + 1)'="Total printed news \nattention (log-transformed)",
  'log(alt_online_all_total_l + 1)'="Total online news\n attention (log-transformed)",
  'log(alt_twitter_total_l + 1)'="Total Twitter/X \nattention (log-transformed)",
  'log(coa_tot_cited_by_total_l + 1)' = "Coauthors' total citations\n(log-transformed)",
  'log(coa_online_combi_total_l + 1)' = "Coauthors' total online \nnews and Twitter/X attention\n(log-transformed)",
  'share_first_au_total_l' = "Total share of first- and \nsingle-authored publications",
  'avg_sjr_total_l' = "Total average SJR \nscore of publications"
)

field_names <- c("arts" = "Arts and\n Humanities",
                 "health" = "Health \nsciences",
                 "soc_sci" = "Social \nsciences",
                 "life" = "Life sciences",
                 "phys" = "Physical \nsciences")

media_names <- c('News attention' = "Printed news",
                 'Online news attention' = "Online news",
                 'Twitter attention' = "Twitter/X")
```

Plot out selected regression coefficients for physical sciences:
```{r fig.width=12, fig.height= 4, warning = F}
# reorder the factor for Figure 2
all_models_plot$term <- ordered(all_models_plot$term,
                                levels = c("(Intercept)",
                                           "inferred_genderw",
                                           "log(count_pubs_total_l + 1)",
                                           "share_first_au_total_l",
                                           "log(cited_by_total_all_l + 1)",
                                           "avg_sjr_total_l",
                                           "log(news_all_total_l + 1)",
                                           "log(alt_online_all_total_l + 1)", 
                                           "log(alt_twitter_total_l + 1)",
                                           "log(coa_tot_cited_by_total_l + 1)",
                                           "log(coa_online_combi_total_l + 1)",
                                           "years_since_first_pub",
                                           "as.factor(year)2014",
                                           "as.factor(year)2015",
                                           "as.factor(year)2016",
                                           "as.factor(year)2017",
                                           "as.factor(year)2018",
                                           "as.factor(year)2019",
                                           "as.factor(year)2020",
                                           "as.factor(year)2021",
                                           "as.factor(year)2022",
                                           "as.factor(year)2023",
                                           "institution_dutch_total_narcisuni_1",
                                           "institution_dutch_total_narcisuni_2",
                                           "institution_dutch_total_narcisuni_3",
                                           "institution_dutch_total_narcisuni_4",
                                           "institution_dutch_total_narcisuni_5",
                                           "institution_dutch_total_narcisuni_6",
                                           "institution_dutch_total_narcisuni_7",
                                           "institution_dutch_total_narcisuni_8",
                                           "institution_dutch_total_narcisuni_9",
                                           "institution_dutch_total_narcisuni_10",
                                           "institution_dutch_total_narcisuni_11",
                                           "institution_dutch_total_narcisuni_12",
                                           "institution_dutch_total_narcisuni_13",
                                           "institution_dutch_total_narcisuni_14",
                                           "institution_dutch_total_narcisuni_15",
                                           "R^2"))

(selected_plot <- all_models_plot %>%
    filter(term %in% c(
      "log(count_pubs_total_l + 1)",
      "share_first_au_total_l",
      "log(cited_by_total_all_l + 1)",
      "avg_sjr_total_l",
      "log(coa_tot_cited_by_total_l + 1)",
      "log(coa_online_combi_total_l + 1)") & field == "phys") %>%
    ggplot(aes(Estimate, fct_rev(term), color = model, shape = model, label = stars)) +
    geom_point(position = position_dodge(width = -0.7), size = 2.5) +
    geom_errorbar(aes(xmin = lower_ci, xmax = upper_ci),
                  width=0,
                  size=0.7,
                  position = position_dodge(width = -0.7)) +
    geom_text(hjust=0, vjust=0, position = position_dodge(width = -0.7), size = 2.3)+
    scale_y_discrete(labels=covariate_names,
                     name = "Field")+
    scale_color_manual(labels = c("Printed news", "Online news", "Twitter/X"), values = c("#bb7693", "#ef6f6a", "#6388b4"))+
    scale_shape_discrete(labels = c("Printed news", "Online news", "Twitter/X"))+
    # scale_x_continuous(limits = c(0.5, 2.25), breaks = seq(0.5, 2.25, by = 0.25))+
    labs(
      x = "Regression coefficients",
      y = NULL,
      color = "Attention type",
      shape = "Attention type"
    ) + 
    geom_vline(xintercept = 0,  colour="black", linetype = "longdash")+
    facet_wrap( ~ model, labeller = as_labeller(media_names), ncol = 3)+
    theme_minimal_hgrid()+
    theme(plot.title = element_text(size = 8),
          axis.text.y = element_text(size = 6),
          axis.title.y = element_blank(),
          axis.text.x = element_text(size = 6, angle = 30, hjust = 0.9) ,
          axis.title.x = element_text(size = 7),
          legend.title=element_text(size=7), 
          legend.text=element_text(size=6),
          strip.text.x=element_text(face="bold", size = 8),
          legend.key.size = unit(0.1, "in"))+
    guides(color = guide_legend(override.aes = list(size = 2.5)),
           shape = guide_legend(override.aes = list(size = 2.5)),
           label = guide_legend(override.aes = list(size = 2.5)))+
    panel_border())

legend <- get_legend(
  # create some space to the left of the legend
  selected_plot
)

combi_plot_selected_coef <- plot_grid(selected_plot + theme(legend.position="none"),
                                      legend,
                                      ncol = 2,
                                      align = 'h',
                                      axis = 'tb',
                                      rel_widths = c(1, 0.131))

```


## Combined plot

Combine the plots.

First, prepare the Figure 2A:
```{r fig.width= 12, fig.height = 4, warning = F}
legend <- get_legend(
  # create some space to the left of the legend
  all_gender_plot
)

combi_plot_regression_pred <- plot_grid(legend,
                                        all_gender_plot,
                                        legend,
                                        ncol = 3,
                                        align = 'h',
                                        axis = 'tb',
                                        rel_widths = c(0.05, 1, 0.135))
```

Then, combine the two:
```{r fig.height=4.5, fig.width=7.5, warning = F}
combi_plot_regression <- plot_grid(
  combi_plot_regression_pred,
  combi_plot_selected_coef,
  ncol = 1,
  nrow = 2,
  axis = 'lr',
  rel_heights = c(1, 1),
  labels = c("A", "B"),
  label_size = 10
)

combi_plot_regression

ggsave2(
  filename = "results/main/Figure_3.png",
  plot = combi_plot_regression,
  width = 7,
  height = 4.5,
  units = c("in"),
  dpi = 1200,
  bg = "white"
)

# save a high-res publication figure
ggsave2(
  filename = "results/high_res_figures/Figure_3.tiff",
  plot = combi_plot_regression,
  width = 7,
  height = 4.5,
  units = c("in"),
  dpi = 900,
  bg = "white"
)
```



## Figure S6 - coefficients for all fields

Plot the rest of the coefficients from the main model to be shown in Figure S6 in the SI Appendix:
```{r fig.width=8, fig.height=10, warning= F, message = F}
media_field_names <- c(media_names,
                       field_names)


(all_plot <- all_models_plot %>%
    filter(term %in% c(
      "log(count_pubs_total_l + 1)",
      "share_first_au_total_l",
      "log(cited_by_total_all_l + 1)",
      "avg_sjr_total_l",
      "log(coa_tot_cited_by_total_l + 1)",
      "log(coa_online_combi_total_l + 1)")) %>%
    ggplot(aes(Estimate, fct_rev(term), color = model, shape = model, label = stars)) +
    geom_point(position = position_dodge(width = -0.7), size = 3) +
    geom_errorbar(aes(xmin = lower_ci, xmax = upper_ci),
                  width=0,
                  size=0.7,
                  position = position_dodge(width = -0.7)) +
    geom_text(hjust=0, vjust=0, position = position_dodge(width = -0.7), size = 3.5)+
    scale_y_discrete(labels=covariate_names,
                     name = "Field")+
    scale_color_manual(labels = c("Printed news", "Online news", "Twitter/X"), values = c("#bb7693", "#ef6f6a", "#6388b4"))+
    scale_shape_discrete(labels = c("Printed news", "Online news", "Twitter/X"))+
    #scale_x_continuous(limits = c(0, 4.5), breaks = seq(0, 4.5, by = 0.5))+
    labs(
      x = "Regression coefficient",
      y = NULL,
      color = "Attention type",
      shape = "Attention type"
    ) + 
    geom_vline(xintercept = 0,  colour="black", linetype = "longdash")+
    facet_grid(field ~ model, labeller = as_labeller(media_field_names), scales = "free_x")+
    theme_minimal_hgrid()+
    theme(plot.title = element_text(size = 11),
          axis.text.y = element_text(size = 9),
          axis.title.y = element_blank(),
          axis.text.x =  element_text(size = 9),
          axis.title.x = element_blank(),
          legend.title=element_blank(), 
          legend.text=element_blank())+
    #strip.text.x=element_text(size = 10))+
    panel_border())


ggsave2(
  filename = "results/supplement_figures/SI_Fig_S6.png",
  plot = all_plot,
  width = 8,
  height = 10,
  units = c("in"),
  dpi = 1200,
  bg = "white"
)
```


